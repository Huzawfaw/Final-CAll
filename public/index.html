<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twilio Dialer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .dialer-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }

        .header i {
            color: #667eea;
            font-size: 24px;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
            font-weight: 600;
        }

        .company-selector {
            margin-bottom: 20px;
        }

        .company-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            color: #333;
            cursor: pointer;
        }

        .company-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        .status {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            font-size: 14px;
        }

        .status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .extension-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .extension-panel h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .extension-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .extension-btn {
            padding: 12px 8px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 500;
            text-align: center;
        }

        .extension-btn:hover {
            border-color: #667eea;
            background: #f0f2ff;
            transform: translateY(-1px);
        }

        .extension-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .phone-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .phone-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
        }

        .phone-input input:focus {
            outline: none;
            border-color: #667eea;
        }

        .call-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 80px;
        }

        .call-btn:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-1px);
        }

        .call-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .hangup-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hangup-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .call-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .hidden {
            display: none !important;
        }

        .call-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .call-info h4 {
            color: #1976d2;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .call-info p {
            color: #333;
            margin-bottom: 10px;
        }

        /* Responsive design */
        @media (max-width: 480px) {
            .dialer-container {
                padding: 20px;
                margin: 10px;
            }
            
            .extension-grid {
                grid-template-columns: 1fr;
            }
            
            .phone-input {
                flex-direction: column;
            }
            
            .call-btn {
                width: 100%;
            }
        }

        /* Loading animation */
        .fa-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="dialer-container">
        <div class="header">
            <i class="fas fa-phone"></i>
            <h1>Twilio Dialer</h1>
        </div>

        <div class="company-selector">
            <select id="companySelect">
                <option value="">Select Company</option>
                <option value="connectiv">Connectiv</option>
                <option value="booksnpayroll">Books & Payroll</option>
            </select>
        </div>

        <div id="status" class="status connecting">
            <i class="fas fa-spinner fa-spin"></i> Select a company to begin
        </div>

        <div id="extensionPanel" class="extension-panel hidden">
            <h3 id="companyTitle">Select Extension</h3>
            <div id="extensionGrid" class="extension-grid">
                <!-- Extensions will be populated here -->
            </div>
        </div>

        <div id="dialerPanel" class="hidden">
            <div class="phone-input">
                <input type="tel" id="phoneNumber" placeholder="Enter phone number" />
                <button id="callBtn" class="call-btn">
                    <i class="fas fa-phone"></i> Call
                </button>
            </div>
        </div>

        <div id="callInfo" class="call-info hidden">
            <h4>Active Call</h4>
            <p id="callDetails">Connected to: <span id="callNumber"></span></p>
            <div class="call-controls">
                <button id="hangupBtn" class="hangup-btn">
                    <i class="fas fa-phone-slash"></i> Hang Up
                </button>
            </div>
        </div>
    </div>

    <!-- Twilio Voice SDK 2.x -->
    <script src="https://sdk.twilio.com/js/voice/releases/2.12.0/twilio.min.js"></script>
    
    <script>
        let device;
        let currentCall;
        let currentCompany = '';
        let currentExtension = '';
        let currentIdentity = '';

        const companies = {
            connectiv: {
                name: 'Connectiv',
                extensions: {
                    101: 'Reception',
                    102: 'Sales', 
                    103: 'Support',
                    104: 'Manager'
                }
            },
            booksnpayroll: {
                name: 'Books & Payroll',
                extensions: {
                    201: 'Accounting',
                    202: 'Payroll',
                    203: 'Bookkeeping', 
                    204: 'Manager'
                }
            }
        };

        // DOM elements
        const companySelect = document.getElementById('companySelect');
        const status = document.getElementById('status');
        const extensionPanel = document.getElementById('extensionPanel');
        const extensionGrid = document.getElementById('extensionGrid');
        const companyTitle = document.getElementById('companyTitle');
        const dialerPanel = document.getElementById('dialerPanel');
        const phoneNumber = document.getElementById('phoneNumber');
        const callBtn = document.getElementById('callBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const callInfo = document.getElementById('callInfo');
        const callNumber = document.getElementById('callNumber');

        // Event listeners
        companySelect.addEventListener('change', handleCompanyChange);
        callBtn.addEventListener('click', makeCall);
        hangupBtn.addEventListener('click', hangupCall);

        // Handle Enter key in phone input
        phoneNumber.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !callBtn.disabled) {
                makeCall();
            }
        });

        function handleCompanyChange() {
            const company = companySelect.value;
            if (company) {
                currentCompany = company;
                showExtensions(company);
            } else {
                hideExtensions();
                updateStatus('connecting', 'Select a company to begin');
            }
        }

        function showExtensions(company) {
            const companyData = companies[company];
            companyTitle.textContent = `${companyData.name} - Select Extension`;
            
            extensionGrid.innerHTML = '';
            
            Object.entries(companyData.extensions).forEach(([ext, name]) => {
                const btn = document.createElement('button');
                btn.className = 'extension-btn';
                btn.textContent = `${ext} - ${name}`;
                btn.onclick = () => selectExtension(ext, name);
                extensionGrid.appendChild(btn);
            });
            
            extensionPanel.classList.remove('hidden');
            updateStatus('connecting', 'Select an extension to connect');
        }

        function hideExtensions() {
            extensionPanel.classList.add('hidden');
            dialerPanel.classList.add('hidden');
            callInfo.classList.add('hidden');
        }

        async function selectExtension(extension, name) {
            // Update UI
            document.querySelectorAll('.extension-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            currentExtension = extension;
            currentIdentity = `ext_${extension}`;
            
            updateStatus('connecting', `Connecting to ${name}...`);
            
            try {
                await connectDevice();
                dialerPanel.classList.remove('hidden');
            } catch (error) {
                console.error('Connection failed:', error);
                updateStatus('error', 'Connection failed. Please try again.');
            }
        }

        async function connectDevice() {
            try {
                // Destroy existing device
                if (device) {
                    device.destroy();
                }

                // Get access token
                const response = await fetch('/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        identity: currentIdentity,
                        company: currentCompany
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to get access token');
                }

                const data = await response.json();
                console.log('‚úÖ Token received for', currentIdentity);

                // Create device with SDK 2.x syntax
                const { Device } = Twilio.Voice;
                device = new Device(data.token, {
                    logLevel: 1,
                    enableRingingState: true,
                    allowIncomingWhileBusy: true
                });

                // Set up event handlers
                device.on('registered', function() {
                    console.log('‚úÖ Device registered');
                    updateStatus('connected', `Connected as Extension ${currentExtension}`);
                });

                device.on('error', function(error) {
                    console.error('‚ùå Device error:', error);
                    updateStatus('error', `Error: ${error.message || 'Connection failed'}`);
                });

                device.on('incoming', function(call) {
                    console.log('üìû Incoming call from:', call.parameters.From);
                    handleIncomingCall(call);
                });

                device.on('tokenWillExpire', function() {
                    console.log('üîÑ Token will expire, refreshing...');
                    connectDevice();
                });

                device.on('registering', function() {
                    console.log('üîÑ Device registering...');
                });

                // Register the device
                await device.register();

            } catch (error) {
                console.error('‚ùå Device connection failed:', error);
                updateStatus('error', 'Connection failed. Check your network.');
                throw error;
            }
        }

        async function makeCall() {
            const number = phoneNumber.value.trim();
            if (!number) {
                alert('Please enter a phone number');
                return;
            }

            if (!device) {
                updateStatus('error', 'Device not connected');
                return;
            }

            try {
                updateStatus('connecting', 'Placing call...');
                callBtn.disabled = true;
                
                // Make call with SDK 2.x syntax
                currentCall = await device.connect({
                    params: {
                        To: number
                    }
                });

                console.log('üìû Call initiated to:', number);

                // Set up call event handlers
                currentCall.on('accept', function() {
                    console.log('‚úÖ Call accepted');
                    showCallInfo(number);
                    updateStatus('connected', 'Call in progress');
                });

                currentCall.on('disconnect', function() {
                    console.log('üìû Call ended');
                    hideCallInfo();
                    updateStatus('connected', `Connected as Extension ${currentExtension}`);
                    currentCall = null;
                    callBtn.disabled = false;
                });

                currentCall.on('cancel', function() {
                    console.log('üìû Call cancelled');
                    hideCallInfo();
                    updateStatus('connected', `Connected as Extension ${currentExtension}`);
                    currentCall = null;
                    callBtn.disabled = false;
                });

                currentCall.on('reject', function() {
                    console.log('üìû Call rejected');
                    hideCallInfo();
                    updateStatus('connected', `Connected as Extension ${currentExtension}`);
                    currentCall = null;
                    callBtn.disabled = false;
                });

            } catch (error) {
                console.error('‚ùå Call failed:', error);
                updateStatus('error', 'Call failed. Please try again.');
                callBtn.disabled = false;
            }
        }

        function hangupCall() {
            if (currentCall) {
                currentCall.disconnect();
            }
        }

        function handleIncomingCall(call) {
            const from = call.parameters.From;
            const accept = confirm(`Incoming call from ${from}. Accept?`);
            
            if (accept) {
                call.accept();
                currentCall = call;
                showCallInfo(from);
                updateStatus('connected', 'Incoming call connected');
                
                call.on('disconnect', function() {
                    hideCallInfo();
                    updateStatus('connected', `Connected as Extension ${currentExtension}`);
                    currentCall = null;
                });
            } else {
                call.reject();
            }
        }

        function showCallInfo(number) {
            callNumber.textContent = number;
            callInfo.classList.remove('hidden');
            callBtn.disabled = true;
        }

        function hideCallInfo() {
            callInfo.classList.add('hidden');
            callBtn.disabled = false;
        }

        function updateStatus(type, message) {
            status.className = `status ${type}`;
            
            let icon = '';
            switch(type) {
                case 'connecting':
                    icon = '<i class="fas fa-spinner fa-spin"></i>';
                    break;
                case 'connected':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
            }
            
            status.innerHTML = `${icon} ${message}`;
        }

        // Initialize
        console.log('üöÄ Twilio Dialer App Starting (SDK 2.x)...');
        updateStatus('connecting', 'Select a company to begin');

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('üì± Page hidden');
            } else {
                console.log('üì± Page visible');
            }
        });
    </script>
</body>
</html>